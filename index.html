import React, { useState, useEffect, useRef, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, collection, doc, setDoc, onSnapshot, deleteDoc } from 'firebase/firestore';

// --- Helper Functions & Constants ---

// IMPORTANT: In a real-world application, you would secure your API keys.
// For this example, we are using a free tier API from Finnhub.
const FINNHUB_API_KEY = 'cnes2gpr01qjco2g1psgcnes2gpr01qjco2g1pt0';
const FINNHUB_BASE_URL = 'https://finnhub.io/api/v1';

// Firebase configuration - will be provided by the environment
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-stock-app';

// --- UI Components ---

const Header = () => (
    <header className="bg-gray-900 text-white shadow-lg">
        <div className="container mx-auto px-4 sm:px-6 lg:px-8">
            <div className="flex items-center justify-between h-16">
                <div className="flex items-center">
                    <svg className="h-8 w-8 text-cyan-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                    </svg>
                    <span className="ml-3 text-2xl font-bold tracking-wider">MarketPulse AI</span>
                </div>
            </div>
        </div>
    </header>
);

const SearchBar = ({ onSearch, isSearching }) => {
    const [symbol, setSymbol] = useState('AAPL');

    const handleSearch = (e) => {
        e.preventDefault();
        if (symbol.trim()) {
            onSearch(symbol.trim().toUpperCase());
        }
    };

    return (
        <form onSubmit={handleSearch} className="p-4 bg-gray-800 rounded-lg shadow-md">
            <div className="flex flex-col sm:flex-row items-center gap-3">
                <label htmlFor="stock-search" className="sr-only">Search Stock</label>
                <input
                    id="stock-search"
                    type="text"
                    value={symbol}
                    onChange={(e) => setSymbol(e.target.value)}
                    placeholder="Enter Stock Ticker (e.g., TSLA)"
                    className="w-full sm:flex-grow bg-gray-700 text-white placeholder-gray-400 border border-gray-600 rounded-md py-2 px-4 focus:outline-none focus:ring-2 focus:ring-cyan-500 transition duration-200"
                />
                <button
                    type="submit"
                    disabled={isSearching}
                    className="w-full sm:w-auto flex items-center justify-center bg-cyan-600 hover:bg-cyan-700 disabled:bg-gray-500 text-white font-bold py-2 px-6 rounded-md transition duration-200 shadow-md transform hover:scale-105"
                >
                    {isSearching ? (
                        <>
                            <Spinner size="sm" />
                            <span className="ml-2">Searching...</span>
                        </>
                    ) : (
                        'Search'
                    )}
                </button>
            </div>
        </form>
    );
};


const ChartComponent = ({ data }) => {
    const chartContainerRef = useRef(null);
    const chartRef = useRef(null);
    const resizeObserver = useRef(null);
    const [isLibLoaded, setIsLibLoaded] = useState(false);

    // Effect to dynamically load the lightweight-charts library script
    useEffect(() => {
        if (typeof window.LightweightCharts !== 'undefined') {
            setIsLibLoaded(true);
            return;
        }

        const script = document.createElement('script');
        script.id = 'lightweight-charts-script';
        script.src = 'https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js';
        script.async = true;
        
        script.onload = () => setIsLibLoaded(true);
        script.onerror = () => console.error("Failed to load lightweight-charts script.");

        document.body.appendChild(script);

        return () => {
            const scriptElement = document.getElementById('lightweight-charts-script');
            if(scriptElement && scriptElement.parentElement) {
                scriptElement.parentElement.removeChild(scriptElement);
            }
        };
    }, []); 

    // Effect to create and manage the chart
    useEffect(() => {
        if (!isLibLoaded || !chartContainerRef.current || !data || data.length === 0 || typeof window.LightweightCharts?.createChart !== 'function') {
            return;
        }
        
        if (chartRef.current) {
            chartRef.current.remove();
        }

        const chart = window.LightweightCharts.createChart(chartContainerRef.current, {
            width: chartContainerRef.current.clientWidth,
            height: 400,
            layout: { background: { color: '#111827' }, textColor: 'rgba(255, 255, 255, 0.9)' },
            grid: { vertLines: { color: '#374151' }, horzLines: { color: '#374151' } },
            crosshair: { mode: 0 },
            priceScale: { borderColor: '#485c7b' },
            timeScale: { borderColor: '#485c7b' },
        });
        chartRef.current = chart;

        const candleSeries = chart.addCandlestickSeries({
            upColor: '#22c55e', downColor: '#ef4444', borderDownColor: '#ef4444',
            borderUpColor: '#22c55e', wickDownColor: '#ef4444', wickUpColor: '#22c55e',
        });
        
        candleSeries.setData(data);
        chart.timeScale().fitContent();

        const handleResize = () => {
            if (chartRef.current && chartContainerRef.current) {
                chartRef.current.applyOptions({ width: chartContainerRef.current.clientWidth });
            }
        };

        resizeObserver.current = new ResizeObserver(handleResize);
        resizeObserver.current.observe(chartContainerRef.current);

        return () => {
            if (resizeObserver.current && chartContainerRef.current) {
                resizeObserver.current.unobserve(chartContainerRef.current);
            }
            if (chartRef.current) {
                chartRef.current.remove();
                chartRef.current = null;
            }
        };
    }, [data, isLibLoaded]); 

    if (!isLibLoaded || !data) {
        return (
            <div className="w-full h-[400px] bg-gray-900 rounded-lg shadow-inner flex flex-col items-center justify-center">
                <Spinner />
                <p className="mt-2 text-gray-400">{!isLibLoaded ? "Loading charting library..." : "Loading chart data..."}</p>
            </div>
        );
    }
    
    if (data.length === 0) {
        return <div className="w-full h-[400px] bg-gray-900 rounded-lg shadow-inner flex items-center justify-center text-gray-400">No chart data available for this stock.</div>
    }

    return <div ref={chartContainerRef} className="w-full h-[400px] bg-gray-900 rounded-lg shadow-inner" />;
};


const DataDisplay = ({ data }) => {
    if (!data || !data.quote) return null;
    const { quote, profile } = data;
    const change = quote.d;
    const changePercent = quote.dp;
    const isPositive = change >= 0;

    const stats = [
        { label: 'Previous Close', value: quote.pc?.toFixed(2) },
        { label: 'Open', value: quote.o?.toFixed(2) },
        { label: 'Day High', value: quote.h?.toFixed(2) },
        { label: 'Day Low', value: quote.l?.toFixed(2) },
        { label: 'Market Cap', value: profile?.marketCapitalization ? `${profile.marketCapitalization.toFixed(2)}M` : 'N/A' },
        { label: 'Exchange', value: profile?.exchange || 'N/A' },
    ];

    return (
        <div className="bg-gray-800 p-4 sm:p-6 rounded-lg shadow-md">
            <div className="flex flex-col sm:flex-row justify-between items-start mb-4">
                <div>
                    <h2 className="text-2xl sm:text-3xl font-bold text-white">{profile?.name || data.symbol} <span className="text-lg text-gray-400">({data.symbol})</span></h2>
                    {profile?.weburl && <a href={profile.weburl} target="_blank" rel="noopener noreferrer" className="text-cyan-400 hover:text-cyan-300 transition duration-200 text-sm">{profile.weburl}</a>}
                </div>
                <div className="text-right mt-4 sm:mt-0">
                    <p className="text-3xl sm:text-4xl font-bold text-white">{quote.c?.toFixed(2)}</p>
                    <p className={`text-lg font-semibold ${isPositive ? 'text-green-500' : 'text-red-500'}`}>
                        {isPositive ? '+' : ''}{change?.toFixed(2)} ({changePercent?.toFixed(2)}%)
                    </p>
                </div>
            </div>
            <div className="grid grid-cols-2 sm:grid-cols-3 gap-4 border-t border-gray-700 pt-4">
                {stats.map(stat => (
                    <div key={stat.label}>
                        <p className="text-sm text-gray-400">{stat.label}</p>
                        <p className="text-md font-semibold text-white">{stat.value || '---'}</p>
                    </div>
                ))}
            </div>
        </div>
    );
};

const NewsFeed = ({ symbol, onNewsFetched }) => {
    const [news, setNews] = useState([]);
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState(null);

    useEffect(() => {
        if (!symbol) return;
        let isMounted = true;
        setLoading(true);
        setError(null);
        
        const fetchNews = async () => {
            try {
                const to = new Date().toISOString().split('T')[0];
                const from = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                const response = await fetch(`${FINNHUB_BASE_URL}/company-news?symbol=${symbol}&from=${from}&to=${to}&token=${FINNHUB_API_KEY}`);
                if (!response.ok) throw new Error(`Failed to fetch news (status: ${response.status})`);
                const data = await response.json();
                if(isMounted) {
                    if (Array.isArray(data)) {
                        setNews(data.slice(0, 10)); 
                        onNewsFetched(data.slice(0, 5));
                    } else {
                        setNews([]);
                        onNewsFetched([]);
                    }
                }
            } catch (err) {
                if(isMounted) setError(err.message);
            } finally {
             if(isMounted) setLoading(false);
            }
        };
        fetchNews();
        return () => { isMounted = false; }
    }, [symbol, onNewsFetched]);

    return (
        <div className="bg-gray-800 p-4 rounded-lg shadow-md">
            <h3 className="text-xl font-bold text-white mb-4">Latest News</h3>
            {loading && <div className="flex justify-center p-4"><Spinner /></div>}
            {error && <p className="text-red-400 text-sm">Error: {error}</p>}
            {!loading && news.length === 0 && <p className="text-gray-400">No recent news found.</p>}
            <div className="space-y-4 max-h-96 overflow-y-auto pr-2">
                {news.map(item => (
                    <a href={item.url} key={item.id} target="_blank" rel="noopener noreferrer" className="block p-3 bg-gray-700 hover:bg-gray-600 rounded-lg transition duration-200">
                        <p className="font-semibold text-white">{item.headline}</p>
                        <p className="text-xs text-gray-400 mt-1">{item.source} - {new Date(item.datetime * 1000).toLocaleDateString()}</p>
                        <p className="text-sm text-gray-300 mt-2">{item.summary}</p>
                    </a>
                ))}
            </div>
        </div>
    );
};

const AiSummary = ({ symbol, news }) => {
    const [summary, setSummary] = useState('');
    const [loading, setLoading] = useState(false);
    
    const generateSummary = useCallback(async () => {
        if (!news || news.length === 0) {
            setSummary('');
            return;
        };
        setLoading(true);
        setSummary('');

        const headlines = news.map(n => n.headline).join('\n');
        const prompt = `Based on the following recent news headlines for ${symbol}, provide a brief, one-paragraph analysis of the overall market sentiment. Is it positive, negative, or neutral? Mention key themes.\n\nHeadlines:\n${headlines}`;

        try {
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error(`API call failed: ${response.status}`);
            
            const result = await response.json();
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
            setSummary(text || 'Could not generate AI summary.');

        } catch (error) {
            console.error("Gemini API error:", error);
            setSummary('Failed to generate AI summary.');
        } finally {
            setLoading(false);
        }
    }, [symbol, news]);

    useEffect(() => {
        generateSummary();
    }, [generateSummary]);

    return (
        <div className="bg-gray-800 p-4 rounded-lg shadow-md">
            <h3 className="text-xl font-bold text-white mb-3">AI News Analysis</h3>
            {loading && <div className="flex items-center text-cyan-400"><Spinner size="sm"/> <span className="ml-2">Analyzing...</span></div>}
            {!loading && summary && <p className="text-gray-300 whitespace-pre-wrap">{summary}</p>}
            {!loading && !summary && <p className="text-gray-400">AI analysis appears here.</p>}
        </div>
    );
};

const AiRecommendations = ({ onSelectStock }) => {
    const [recommendations, setRecommendations] = useState([]);
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState(null);

    const getRecommendations = async () => {
        setLoading(true);
        setError(null);
        setRecommendations([]);

        try {
            // 1. Fetch general market news
            const newsResponse = await fetch(`${FINNHUB_BASE_URL}/news?category=general&token=${FINNHUB_API_KEY}`);
            if (!newsResponse.ok) throw new Error('Failed to fetch market news.');
            const marketNews = await newsResponse.json();
            const headlines = marketNews.slice(0, 15).map(n => n.headline).join('\n');

            // 2. Prompt Gemini for recommendations in JSON format
            const prompt = `Act as a financial analyst. Based on these recent market news headlines, identify 3 promising stocks. For each stock, provide the ticker symbol, company name, and a concise one-sentence reason for the recommendation. Do not include any stocks that are not publicly traded.\n\nHeadlines:\n${headlines}`;
            
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                symbol: { type: "STRING" },
                                companyName: { type: "STRING" },
                                reason: { type: "STRING" }
                            },
                            required: ["symbol", "companyName", "reason"]
                        }
                    }
                }
            };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            const geminiResponse = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!geminiResponse.ok) throw new Error(`Gemini API failed with status: ${geminiResponse.status}`);
            
            const result = await geminiResponse.json();
            const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (jsonText) {
                setRecommendations(JSON.parse(jsonText));
            } else {
                throw new Error("AI model returned an empty response.");
            }

        } catch (err) {
            console.error("AI Recommendation Error:", err);
            setError(err.message);
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="bg-gray-800 p-4 rounded-lg shadow-md">
            <h3 className="text-xl font-bold text-white mb-3">AI Stock Recommendations</h3>
            <p className="text-xs text-gray-500 mb-4 italic">
                Disclaimer: This is not financial advice. AI-generated content may be inaccurate. Always do your own research.
            </p>
            <button
                onClick={getRecommendations}
                disabled={loading}
                className="w-full bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-600 text-white font-bold py-2 px-4 rounded-md transition duration-200 flex items-center justify-center"
            >
                {loading ? <><Spinner size="sm" /><span className="ml-2">Analyzing Market...</span></> : 'Get New Recommendations'}
            </button>

            <div className="mt-4 space-y-3">
                {error && <p className="text-red-400 text-sm">Error: {error}</p>}
                {recommendations.map((stock) => (
                    <div key={stock.symbol} className="bg-gray-700 p-3 rounded-lg">
                        <div className="flex justify-between items-center">
                            <h4 className="font-bold text-white">{stock.companyName} ({stock.symbol})</h4>
                            <button 
                                onClick={() => onSelectStock(stock.symbol)}
                                className="text-cyan-400 hover:text-cyan-300 text-sm font-semibold"
                            >
                                View
                            </button>
                        </div>
                        <p className="text-sm text-gray-300 mt-1">{stock.reason}</p>
                    </div>
                ))}
            </div>
        </div>
    );
};


const Watchlist = ({ db, userId, onSelectStock }) => {
    const [watchlist, setWatchlist] = useState([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        if (!db || !userId) {
            setLoading(false);
            return;
        }
        setLoading(true);
        const collectionPath = `artifacts/${appId}/users/${userId}/watchlist`;
        const q = collection(db, collectionPath);
        const unsubscribe = onSnapshot(q, (querySnapshot) => {
            const stocks = [];
            querySnapshot.forEach((doc) => stocks.push({ id: doc.id, ...doc.data() }));
            setWatchlist(stocks);
            setLoading(false);
        }, (error) => {
            console.error("Watchlist snapshot error:", error);
            setLoading(false);
        });

        return () => unsubscribe();
    }, [db, userId]);

    const removeFromWatchlist = async (symbol) => {
        if (!db || !userId) return;
        try {
            const docPath = `artifacts/${appId}/users/${userId}/watchlist/${symbol}`;
            await deleteDoc(doc(db, docPath));
        } catch (error) {
            console.error("Error removing from watchlist:", error);
        }
    };
    
    return (
        <div className="bg-gray-800 p-4 rounded-lg shadow-md">
            <h3 className="text-xl font-bold text-white mb-4">My Watchlist</h3>
            {loading && <div className="flex justify-center p-4"><Spinner /></div>}
            {!loading && watchlist.length === 0 && <p className="text-gray-400">Add stocks via the star icon.</p>}
            <ul className="space-y-2">
                {watchlist.map(stock => (
                    <li key={stock.id} className="flex justify-between items-center bg-gray-700 p-2 rounded-md">
                        <button onClick={() => onSelectStock(stock.id)} className="text-left flex-grow hover:text-cyan-400 transition">
                            <span className="font-bold">{stock.id}</span>
                            <span className="text-sm text-gray-300 ml-2">{stock.name}</span>
                        </button>
                        <button onClick={() => removeFromWatchlist(stock.id)} className="text-red-500 hover:text-red-400 p-1 rounded-full transition">
                           <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                              <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
                            </svg>
                        </button>
                    </li>
                ))}
            </ul>
        </div>
    );
};

const AddToWatchlistButton = ({ db, userId, stockData, watchlist }) => {
    if (!stockData || !stockData.symbol || !db || !userId) return null;
    
    const { symbol, profile } = stockData;
    const isInWatchlist = watchlist.some(item => item.id === symbol);

    const handleWatchlistToggle = async () => {
        const docPath = `artifacts/${appId}/users/${userId}/watchlist/${symbol}`;
        try {
            if (isInWatchlist) {
                await deleteDoc(doc(db, docPath));
            } else {
                await setDoc(doc(db, docPath), { name: profile?.name || symbol });
            }
        } catch (error) {
             console.error("Error toggling watchlist:", error);
        }
    };

    return (
        <button 
          onClick={handleWatchlistToggle}
          className={`ml-4 p-2 rounded-full transition duration-200 ${isInWatchlist ? 'bg-yellow-500 text-white' : 'bg-gray-600 hover:bg-yellow-500 text-gray-300 hover:text-white'}`}
          title={isInWatchlist ? "Remove from Watchlist" : "Add to Watchlist"}
        >
            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
            </svg>
        </button>
    );
};

const Spinner = ({size = 'md'}) => {
    const sizeClasses = {
        sm: 'w-5 h-5 border-2',
        md: 'w-8 h-8 border-4',
        lg: 'w-12 h-12 border-4'
    }
    return <div className={`animate-spin rounded-full ${sizeClasses[size]} border-cyan-400 border-t-transparent`}></div>;
};


// --- Main App Component ---

export default function App() {
    const [stockData, setStockData] = useState(null);
    const [chartData, setChartData] = useState(null);
    const [isSearching, setIsSearching] = useState(true);
    const [error, setError] = useState(null);
    const [currentSymbol, setCurrentSymbol] = useState('AAPL');

    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [userId, setUserId] = useState(null);
    const [watchlist, setWatchlist] = useState([]);
    
    const [newsForAI, setNewsForAI] = useState([]);

    useEffect(() => {
        try {
            if (Object.keys(firebaseConfig).length > 0) {
                 const app = initializeApp(firebaseConfig);
                 setDb(getFirestore(app));
                 setAuth(getAuth(app));
            }
        } catch (e) {
            console.error("Firebase init error", e);
            setError("Could not connect to services.");
        }
    }, []);

    useEffect(() => {
        if (!auth) return;
        const signIn = async () => {
             try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication Error:", error);
                setError("Authentication failed.");
            }
        };
        const unsubscribe = onAuthStateChanged(auth, user => setUserId(user ? user.uid : null));
        signIn();
        return unsubscribe;
    }, [auth]);

    const handleSearch = useCallback(async (symbol) => {
        setIsSearching(true);
        setError(null);
        setStockData(null); 
        setChartData(null);
        setNewsForAI([]); 
        setCurrentSymbol(symbol);

        try {
            const to = Math.floor(Date.now() / 1000);
            const from = to - (365 * 24 * 60 * 60);
            
            const quotePromise = fetch(`${FINNHUB_BASE_URL}/quote?symbol=${symbol}&token=${FINNHUB_API_KEY}`).then(res => res.json());
            const profilePromise = fetch(`${FINNHUB_BASE_URL}/stock/profile2?symbol=${symbol}&token=${FINNHUB_API_KEY}`).then(res => res.json());
            const chartPromise = fetch(`${FINNHUB_BASE_URL}/stock/candle?symbol=${symbol}&resolution=D&from=${from}&to=${to}&token=${FINNHUB_API_KEY}`).then(res => res.json());

            const [quote, profile, chart] = await Promise.all([quotePromise, profilePromise, chartPromise]);

            if (!quote || (quote.c === 0 && quote.pc === 0)) {
                 throw new Error(`No valid price data for "${symbol}".`);
            }
            
            setStockData({ symbol, quote, profile });

            if (chart.s === 'ok' && chart.c?.length > 0) {
                const formattedData = chart.t.map((time, index) => ({
                    time, open: chart.o[index], high: chart.h[index], low: chart.l[index], close: chart.c[index],
                }));
                setChartData(formattedData);
            } else {
                setChartData([]);
            }

        } catch (err) {
            const enhancedError = `${err.message} This may be due to an invalid ticker or an API key issue.`;
            setError(enhancedError);
        } finally {
             setIsSearching(false);
        }
    }, []);

    useEffect(() => {
        handleSearch('AAPL');
    }, [handleSearch]);
    
    useEffect(() => {
        if (!db || !userId) return;
        const collectionPath = `artifacts/${appId}/users/${userId}/watchlist`;
        const q = collection(db, collectionPath);
        const unsubscribe = onSnapshot(q, (querySnapshot) => {
            const stocks = [];
            querySnapshot.forEach((doc) => stocks.push({ id: doc.id, ...doc.data() }));
            setWatchlist(stocks);
        }, (error) => console.error("Watchlist listener error:", error));
        return unsubscribe;
    }, [db, userId]);

    const handleNewsFetched = useCallback((news) => setNewsForAI(news), []);

    return (
        <div className="bg-gray-900 text-gray-200 min-h-screen font-sans">
            <Header />
            <main className="container mx-auto p-2 sm:p-4 lg:p-6">
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    {/* Main Content Column */}
                    <div className="lg:col-span-2 space-y-6">
                        <SearchBar onSearch={handleSearch} isSearching={isSearching} />

                        {error && (
                             <div className="bg-red-900 border border-red-500 text-red-200 px-4 py-3 rounded-lg shadow-md" role="alert">
                                <strong className="font-bold">Error: </strong>
                                <span className="block sm:inline">{error}</span>
                            </div>
                        )}
                        
                        {isSearching && !error && (
                            <div className="flex flex-col items-center justify-center p-8 bg-gray-800 rounded-lg space-y-4">
                               <Spinner size="lg" />
                               <p className="text-lg">Fetching data for {currentSymbol}...</p>
                            </div>
                        )}

                        {!isSearching && stockData && (
                            <div className="space-y-6">
                                <div className="flex items-center">
                                    <div className="flex-grow">
                                        <DataDisplay data={stockData} />
                                    </div>
                                    <AddToWatchlistButton db={db} userId={userId} stockData={stockData} watchlist={watchlist} />
                                </div>
                                <ChartComponent data={chartData} />
                                <AiSummary symbol={stockData.symbol} news={newsForAI} />
                            </div>
                        )}

                    </div>

                    {/* Right Sidebar Column */}
                    <div className="lg:col-span-1 space-y-6">
                         <AiRecommendations onSelectStock={handleSearch} />
                         <Watchlist db={db} userId={userId} onSelectStock={handleSearch} />
                         {!isSearching && currentSymbol && (
                            <NewsFeed symbol={currentSymbol} onNewsFetched={handleNewsFetched} />
                         )}
                    </div>
                </div>
            </main>
        </div>
    );
}
